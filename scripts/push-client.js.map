{"version":3,"names":[],"mappings":"","sources":["scripts/push-client.js"],"sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n'use strict';\n\n/* eslint-env browser */\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar PushClient = function () {\n  function PushClient(stateChangeCb, subscriptionUpdate) {\n    var _this = this;\n\n    _classCallCheck(this, PushClient);\n\n    this._stateChangeCb = stateChangeCb;\n    this._subscriptionUpdate = subscriptionUpdate;\n\n    this._state = {\n      UNSUPPORTED: {\n        id: 'UNSUPPORTED',\n        interactive: false,\n        pushEnabled: false\n      },\n      INITIALISING: {\n        id: 'INITIALISING',\n        interactive: false,\n        pushEnabled: false\n      },\n      PERMISSION_DENIED: {\n        id: 'PERMISSION_DENIED',\n        interactive: false,\n        pushEnabled: false\n      },\n      PERMISSION_GRANTED: {\n        id: 'PERMISSION_GRANTED',\n        interactive: true\n      },\n      PERMISSION_PROMPT: {\n        id: 'PERMISSION_PROMPT',\n        interactive: true,\n        pushEnabled: false\n      },\n      ERROR: {\n        id: 'ERROR',\n        interactive: false,\n        pushEnabled: false\n      },\n      STARTING_SUBSCRIBE: {\n        id: 'STARTING_SUBSCRIBE',\n        interactive: false,\n        pushEnabled: true\n      },\n      SUBSCRIBED: {\n        id: 'SUBSCRIBED',\n        interactive: true,\n        pushEnabled: true\n      },\n      STARTING_UNSUBSCRIBE: {\n        id: 'STARTING_UNSUBSCRIBE',\n        interactive: false,\n        pushEnabled: false\n      },\n      UNSUBSCRIBED: {\n        id: 'UNSUBSCRIBED',\n        interactive: true,\n        pushEnabled: false\n      }\n    };\n\n    if (!('serviceWorker' in navigator)) {\n      this._stateChangeCb(this._state.UNSUPPORTED);\n      return;\n    }\n\n    if (!('PushManager' in window)) {\n      this._stateChangeCb(this._state.UNSUPPORTED);\n      return;\n    }\n\n    if (!('showNotification' in ServiceWorkerRegistration.prototype)) {\n      this._stateChangeCb(this._state.UNSUPPORTED);\n      return;\n    }\n\n    navigator.serviceWorker.ready.then(function () {\n      _this._stateChangeCb(_this._state.INITIALISING);\n      _this.setUpPushPermission();\n    });\n  }\n\n  _createClass(PushClient, [{\n    key: '_permissionStateChange',\n    value: function _permissionStateChange(permissionState) {\n      // If the notification permission is denied, it's a permanent block\n      switch (permissionState) {\n        case 'denied':\n          this._stateChangeCb(this._state.PERMISSION_DENIED);\n          break;\n        case 'granted':\n          this._stateChangeCb(this._state.PERMISSION_GRANTED);\n          break;\n        case 'default':\n          this._stateChangeCb(this._state.PERMISSION_PROMPT);\n          break;\n        default:\n          console.error('Unexpected permission state: ', permissionState);\n          break;\n      }\n    }\n  }, {\n    key: 'setUpPushPermission',\n    value: function setUpPushPermission() {\n      var _this2 = this;\n\n      this._permissionStateChange(Notification.permission);\n\n      return navigator.serviceWorker.ready.then(function (serviceWorkerRegistration) {\n        // Let's see if we have a subscription already\n        return serviceWorkerRegistration.pushManager.getSubscription();\n      }).then(function (subscription) {\n        if (!subscription) {\n          // NOOP since we have no subscription and the permission state\n          // will inform whether to enable or disable the push UI\n          return;\n        }\n\n        _this2._stateChangeCb(_this2._state.SUBSCRIBED);\n\n        // Update the current state with the\n        // subscriptionid and endpoint\n        _this2._subscriptionUpdate(subscription);\n      }).catch(function (err) {\n        console.log(err);\n        _this2._stateChangeCb(_this2._state.ERROR, err);\n      });\n    }\n  }, {\n    key: 'subscribeDevice',\n    value: function subscribeDevice() {\n      var _this3 = this;\n\n      this._stateChangeCb(this._state.STARTING_SUBSCRIBE);\n\n      // We need the service worker registration to access the push manager\n      navigator.serviceWorker.ready.then(function (serviceWorkerRegistration) {\n        return serviceWorkerRegistration.pushManager.subscribe({ userVisibleOnly: true });\n      }).then(function (subscription) {\n        _this3._stateChangeCb(_this3._state.SUBSCRIBED);\n        _this3._subscriptionUpdate(subscription);\n      }).catch(function (subscriptionErr) {\n        // Check for a permission prompt issue\n        _this3._permissionStateChange(Notification.permission);\n\n        if (Notification.permission !== 'denied' && Notification.permission !== 'default') {\n          // If the permission wasnt denied or prompt, that means the\n          // permission was accepted, so this must be an error\n          _this3._stateChangeCb(_this3._state.ERROR, subscriptionErr);\n        }\n      });\n    }\n  }, {\n    key: 'unsubscribeDevice',\n    value: function unsubscribeDevice() {\n      var _this4 = this;\n\n      // Disable the switch so it can't be changed while\n      // we process permissions\n      // window.PushDemo.ui.setPushSwitchDisabled(true);\n\n      this._stateChangeCb(this._state.STARTING_UNSUBSCRIBE);\n\n      navigator.serviceWorker.ready.then(function (serviceWorkerRegistration) {\n        return serviceWorkerRegistration.pushManager.getSubscription();\n      }).then(function (pushSubscription) {\n        // Check we have everything we need to unsubscribe\n        if (!pushSubscription) {\n          _this4._stateChangeCb(_this4._state.UNSUBSCRIBED);\n          _this4._subscriptionUpdate(null);\n          return;\n        }\n\n        // TODO: Remove the device details from the server\n        // i.e. the pushSubscription.subscriptionId and\n        // pushSubscription.endpoint\n        return pushSubscription.unsubscribe().then(function (successful) {\n          if (!successful) {\n            // The unsubscribe was unsuccessful, but we can\n            // remove the subscriptionId from our server\n            // and notifications will stop\n            // This just may be in a bad state when the user returns\n            console.error('We were unable to unregister from push');\n          }\n        });\n      }).then(function () {\n        _this4._stateChangeCb(_this4._state.UNSUBSCRIBED);\n        _this4._subscriptionUpdate(null);\n      }).catch(function (err) {\n        console.error('Error thrown while revoking push notifications. ' + 'Most likely because push was never registered', err);\n      });\n    }\n  }]);\n\n  return PushClient;\n}();\n\nexports.default = PushClient;\n\n},{}]},{},[1]);\n"],"file":"scripts/push-client.js","sourceRoot":"/source/"}